<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Product - A.Production (of sorts)</title>
<link rel="stylesheet" href="/styles/base.css"><link rel="stylesheet" href="/styles/components.css">
<script defer src="/_vercel/speed-insights/script.js"></script>
<script defer src="/_vercel/insights/script.js"></script>
<style>
  .hidden { display: none !important; }
  a.disabled { opacity: .6; pointer-events: none; text-decoration: none; }
  .list { list-style: none; padding: 0; margin: 0; }
  .list .row { display: flex; align-items: center; padding: 6px 0; gap: 8px; }
</style>
</head><body>
  <div class="container">
    <nav class="nav" id="nav">
      <div class="brand">
        <span class="logo">
          <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="g1" x1="0" x2="1"><stop offset="0%" stop-color="#8a7cff"/><stop offset="100%" stop-color="#e45aff"/></linearGradient>
              <radialGradient id="g2" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#e45aff"/><stop offset="100%" stop-color="#8a7cff"/></radialGradient>
            </defs>
            <circle class="ring" cx="20" cy="20" r="14" />
            <circle class="dot" cx="28" cy="12" r="3"/>
          </svg>
        </span>
        <span class="badge">A.Production</span><span class="muted" style="margin-left:8px">(of sorts)</span>
      </div>
      <button class="nav-toggle" id="nav-toggle" aria-label="Menu"></button>
      <div class="nav-links" id="nav-links">
        <a href="/index.html" id="nav-home">Home</a>
        <a href="/services.html" id="nav-services">Services</a>
        <a href="/products.html" id="nav-products">Products</a>
        <a href="/account.html" id="nav-account">Account</a>
        <a href="/control-panel.html" id="nav-control">Control</a>
        <a href="/login.html" id="nav-login">Login</a>
        <a href="#" id="nav-logout">Logout</a>
      </div>
    </nav>

    <div id="content" class="grid">
      <div class="card product" id="detail"></div>

      <a id="view-course" class="button ghost hidden" style="justify-content:center">View course</a>

      <button class="button desktop-only" id="buy">Buy Now</button>

      <section id="downloads-section" class="card hidden" style="grid-column:1 / -1">
        <h3>Included Downloads</h3>
        <ul id="downloads-list" class="list"></ul>
      </section>
    </div>

    <section id="service-form" class="card hidden" style="grid-column:1 / -1">
      <h3>Request a Quote</h3>
      <form id="quote" class="grid" style="gap:12px">
        <input class="input" name="title" placeholder="Project title (e.g., Landing page redesign)" required>
        <textarea class="input" name="details" placeholder="Tell us what you need..." rows="5"></textarea>
        <button class="button" type="submit">Submit request</button>
      </form>
      <p id="quote-msg" class="muted" aria-live="polite"></p>
    </section>
  </div>

  <div class="buybar mobile-only hidden" id="buybar">
    <div class="row" style="gap:10px"><span id="buybar-title" class="muted"></span></div>
    <div class="row" style="margin-left:auto;gap:10px">
      <div class="price" id="buybar-price"></div>
      <a id="buybar-course" class="button ghost hidden">View course</a>
      <a href="#" class="button" id="buybar-btn">Buy Now</a>
    </div>
  </div>

<script type="module">
  import { api, money, track, Service } from '/scripts/api.js';
  import { wireNav } from '/scripts/nav.js';

  await wireNav('nav-products');

  const qs = new URLSearchParams(location.search);
  const id = qs.get('id');
  if (!id) {
    document.getElementById('detail').innerHTML = '<h2>Missing product id</h2>';
    throw new Error('No product id in querystring');
  }

  const detailEl = document.getElementById('detail');
  const buyBtn = document.getElementById('buy');
  const buybar = document.getElementById('buybar');
  const buybarBtn = document.getElementById('buybar-btn');
  const buybarTitle = document.getElementById('buybar-title');
  const buybarPrice = document.getElementById('buybar-price');
  const desktopCourseBtn = document.getElementById('view-course');
  const mobileCourseBtn = document.getElementById('buybar-course');
  const downloadsSection = document.getElementById('downloads-section');
  const downloadsList = document.getElementById('downloads-list');
  const serviceSection = document.getElementById('service-form');
  const serviceForm = document.getElementById('quote');
  const serviceMsg = document.getElementById('quote-msg');

  let product = null;

  async function loadProduct() {
    try {
      product = await api(`/products/${id}`);
      renderProduct();
    } catch (error) {
      detailEl.innerHTML = `<h2>${error.message || 'Failed to load product'}</h2>`;
      throw error;
    }
  }

  function renderProduct() {
    if (!product) return;

    detailEl.innerHTML = `
      <span class="badge">${(product.kind || 'PRODUCT').toUpperCase()}</span>
      <h1>${product.title}</h1>
      ${product.subtitle ? `<h3 class="muted">${product.subtitle}</h3>` : ''}
      <p class="muted">${product.description || ''}</p>
      <div class="price">${money(product.price_cents)}</div>
    `;

    renderCourseButtons();
    renderDownloads();
    renderPurchaseState();
    renderServiceForm();
  }

  function renderCourseButtons() {
    const hasCourse = !!product?.course;
    const courseHref = `/course.html?id=${product.id}`;
    if (hasCourse) {
      desktopCourseBtn.classList.remove('hidden');
      desktopCourseBtn.href = courseHref;
      mobileCourseBtn.classList.remove('hidden');
      mobileCourseBtn.href = courseHref;
    } else {
      desktopCourseBtn.classList.add('hidden');
      desktopCourseBtn.removeAttribute('href');
      mobileCourseBtn.classList.add('hidden');
      mobileCourseBtn.removeAttribute('href');
    }
  }

  function renderDownloads() {
    downloadsList.innerHTML = '';
    const assets = product?.assets || [];
    if (!assets.length) {
      downloadsSection.classList.add('hidden');
      return;
    }

    assets.forEach((asset) => {
      const li = document.createElement('li');
      li.className = 'row';
      const link = document.createElement('a');
      link.textContent = asset.label;
      if (asset.file_key) {
        link.href = `/api/products/${product.id}?asset=${asset.id}&download=1`;
        link.target = '_blank';
        link.rel = 'noopener';
      } else {
        link.href = '#';
        link.classList.add('disabled');
        link.addEventListener('click', (event) => {
          event.preventDefault();
          alert('Purchase to unlock this download.');
        });
      }
      li.appendChild(link);
      downloadsList.appendChild(li);
    });

    downloadsSection.classList.remove('hidden');
  }

  function renderPurchaseState() {
    if (product.kind === 'service') {
      buyBtn.classList.add('hidden');
      buybar.classList.add('hidden');
      return;
    }

    buyBtn.classList.remove('hidden');
    buybar.classList.remove('hidden');

    const owned = !!product.owned;
    buybarTitle.textContent = product.title;
    buybarPrice.textContent = money(product.price_cents);

    if (owned) {
      buyBtn.textContent = 'Owned';
      buyBtn.disabled = true;
      buyBtn.classList.add('ghost');
      buyBtn.onclick = null;

      buybarBtn.textContent = 'Owned';
      buybarBtn.classList.add('ghost');
      buybarBtn.href = '/account.html';
      buybarBtn.onclick = null;
    } else {
      buyBtn.textContent = 'Buy Now';
      buyBtn.disabled = false;
      buyBtn.classList.remove('ghost');
      buyBtn.onclick = handlePurchase;

      buybarBtn.textContent = 'Buy Now';
      buybarBtn.classList.remove('ghost');
      buybarBtn.href = '#';
      buybarBtn.onclick = (event) => {
        event.preventDefault();
        handlePurchase();
      };
    }
  }

  function renderServiceForm() {
    if (product.kind !== 'service') {
      serviceSection.classList.add('hidden');
      return;
    }
    serviceSection.classList.remove('hidden');
    serviceMsg.textContent = '';
  }

  async function handlePurchase() {
    try {
      await api('/orders', { method: 'POST', body: JSON.stringify({ product_id: id, qty: 1 }) });
      track('purchase', { id, title: product.title, kind: product.kind, amount: (product.price_cents || 0) / 100 });
      await loadProduct();
    } catch (error) {
      alert(error.message || 'Checkout failed');
    }
  }

  serviceForm.addEventListener('submit', async (event) => {
    if (product.kind !== 'service') return;
    event.preventDefault();
    serviceMsg.textContent = '';
    const fd = new FormData(serviceForm);
    const payload = {
      service_id: product.id,
      title: String(fd.get('title') || '').trim(),
      details: String(fd.get('details') || '').trim()
    };
    if (!payload.title) {
      serviceMsg.textContent = 'Please add a project title.';
      return;
    }
    try {
      await Service.request(payload);
      serviceForm.reset();
      serviceMsg.textContent = 'Request submitted. We will email once it is quoted.';
    } catch (error) {
      const errMsg = (error && error.message) || 'Failed to submit request';
      serviceMsg.textContent = errMsg === 'Unauthorized' ? 'Login to submit a request.' : errMsg;
    }
  });

  await loadProduct();
</script>
</body></html>
