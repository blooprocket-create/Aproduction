<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Product — A.Production (of sorts)</title>
<link rel="stylesheet" href="/styles/base.css"><link rel="stylesheet" href="/styles/components.css">
<script defer src="/_vercel/speed-insights/script.js"></script>
<script defer src="/_vercel/insights/script.js"></script>
<style>
  .hidden{display:none!important}
  a.disabled{opacity:.6;pointer-events:none;text-decoration:none}
  .list{list-style:none;padding:0;margin:0}
  .list .row{display:flex;align-items:center;padding:6px 0;gap:8px}
  .downloads a{ color: var(--link, #cdb4ff); }
</style>
</head><body>
  <div class="container">
    <nav class="nav" id="nav"></nav>

    <div id="content" class="grid">
      <div class="card product" id="detail"></div>
      <a id="view-course" class="btn secondary hidden">View course</a>
      <button class="button desktop-only" id="buy">Buy Now</button>

      <section id="service-form" class="card hidden" style="grid-column:1 / -1">
        <h3>Request a Quote</h3>
        <form id="quote">
          <div class="row"><input name="title" placeholder="Project title (e.g., Landing page redesign)" required></div>
          <div class="row"><textarea name="details" placeholder="Tell us what you need…" rows="5"></textarea></div>
          <button class="button" type="submit">Submit request</button>
        </form>
        <p id="quote-msg" class="muted"></p>
      </section>

      <section id="downloads-section" class="card downloads hidden" style="grid-column: 1 / -1;">
        <h3>Included Downloads</h3>
        <ul id="downloads-list" class="list"></ul>
      </section>
    </div>
  </div>

  <div class="buybar mobile-only hidden" id="buybar">
    <div class="row" style="gap:10px"><span id="buybar-title" class="muted"></span></div>
    <div class="row" style="margin-left:auto;gap:10px">
      <div class="price" id="buybar-price"></div>
      <a id="buybar-course" class="btn secondary hidden">View course</a>
      <a href="#" class="button" id="buybar-btn">Buy Now</a>
    </div>
  </div>

<script type="module">
  import { api, money, Service, currentUser } from '/scripts/api.js';
  import { wireNav } from '/scripts/nav.js';
  await wireNav('nav-products');

  const qs = new URLSearchParams(location.search);
  const id = qs.get('id');
  if (!id) { document.getElementById('detail').innerHTML = '<h2>Missing product id</h2>'; throw new Error('no id'); }

  let p = null;
  try { p = await api('/products/' + id); } catch(e){ alert(e.message); }
  if (!p) { document.getElementById('detail').innerHTML = '<h2>Product not found</h2>'; throw new Error('no product'); }

  const d = document.getElementById('detail');
  d.innerHTML = \`
    <span class="badge">\${(p.kind || 'PRODUCT').toUpperCase()}</span>
    <h1>\${p.title}</h1>
    \${p.subtitle ? \`<h3 class="muted">\${p.subtitle}</h3>\` : ''}
    <p class="muted">\${p.description || ''}</p>
    <div class="price">\${money(p.price_cents)} </div>
  \`;

  const desktopCourseBtn = document.getElementById('view-course');
  const mobileCourseBtn  = document.getElementById('buybar-course');
  const courseHref = \`/course.html?id=\${p.id}\`;
  if (p.course) {
    desktopCourseBtn?.classList.remove('hidden'); desktopCourseBtn && (desktopCourseBtn.href = courseHref);
    mobileCourseBtn?.classList.remove('hidden');  mobileCourseBtn && (mobileCourseBtn.href = courseHref);
  } else {
    desktopCourseBtn?.classList.add('hidden'); mobileCourseBtn?.classList.add('hidden');
  }

  const downloadsSection = document.getElementById('downloads-section');
  const downloadsList = document.getElementById('downloads-list');
  if (downloadsSection && downloadsList) {
    downloadsList.innerHTML = '';
    (p.assets || []).forEach(a => {
      const li = document.createElement('li'); li.className = 'row';
      const link = document.createElement('a'); link.textContent = a.label;
      if (a.file_key) { link.href = \`/api/products/\${p.id}?asset=\${a.id}&download=1\`; link.target='_blank'; link.rel='noopener'; }
      else { link.href='#'; link.classList.add('disabled'); link.onclick = e => { e.preventDefault(); alert('Purchase to unlock this download.'); }; }
      li.appendChild(link); downloadsList.appendChild(li);
    });
    if ((p.assets || []).length > 0) downloadsSection.classList.remove('hidden');
  }

  const isService = p.kind === 'service';
  const buyBtn = document.getElementById('buy');
  const buybar = document.getElementById('buybar');
  const buybarBtn = document.getElementById('buybar-btn');

  if (isService) {
    buyBtn?.classList.add('hidden');
    buybar?.classList.add('hidden');

    const formWrap = document.getElementById('service-form');
    const form = document.getElementById('quote');
    formWrap.classList.remove('hidden');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const payload = { service_id: p.id, title: String(fd.get('title')||'').trim(), details: String(fd.get('details')||'').trim() };
      if (!payload.title) return alert('Please add a title');
      try {
        await Service.request(payload);
        document.getElementById('quote-msg').textContent = 'Request submitted. We\'ll email you once it\'s quoted.';
        form.reset();
      } catch (err) { alert(err.message || 'Failed to submit request'); }
    });
  } else {
    const buy = async () => {
      try {
        await api('/orders', { method:'POST', body: JSON.stringify({ product_id: id, qty: 1 }) });
        p.owned = true;
        if (buyBtn) { buyBtn.textContent='Owned'; buyBtn.disabled=true; buyBtn.classList.add('ghost'); }
        if (buybarBtn) { buybarBtn.textContent='Owned'; buybarBtn.classList.add('ghost'); buybarBtn.href='/account.html'; buybarBtn.onclick=null; }
        location.reload();
      } catch (e) { alert(e.message); }
    };

    if (buyBtn) { if (p.owned) { buyBtn.textContent='Owned'; buyBtn.disabled=true; buyBtn.classList.add('ghost'); } else { buyBtn.onclick = buy; } }
    if (buybar) {
      document.getElementById('buybar-title').textContent = p.title;
      document.getElementById('buybar-price').textContent = money(p.price_cents);
      if (p.owned) { buybarBtn.textContent='Owned'; buybarBtn.classList.add('ghost'); buybarBtn.href='/account.html'; buybarBtn.onclick=null; }
      else { buybarBtn.textContent='Buy Now'; buybarBtn.onclick = (e)=>{ e.preventDefault(); buy(); }; }
      buybar.classList.remove('hidden');
    }
  }
</script>
<script type="module" src="/scripts/nav.js"></script>
</body></html>
