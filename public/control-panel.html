<!doctype html><html><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Control Panel — A.Production (of sorts)</title>
<link rel="stylesheet" href="/styles/base.css"><link rel="stylesheet" href="/styles/components.css">
</head><body><div class="container">
  <nav class="nav"><a href="/index.html">A.Production</a><span class="muted">(of sorts)</span><div style="margin-left:auto"><a href="#" id="logout">Logout</a></div></nav>
  <h1>Control Panel</h1>
  <div id="who" class="muted"></div>

  <div id="admin" class="grid cols-3 hidden">
    <div class="card"><h3>Create Product/Service</h3>
      <form id="create" class="grid">
        <select name="kind"><option value="product">Product</option><option value="course">Course</option><option value="service">Service</option></select>
        <input class="input" name="slug" placeholder="slug">
        <input class="input" name="title" placeholder="title">
        <textarea class="input" name="description" placeholder="description"></textarea>
        <input class="input" name="price_cents" placeholder="price in cents" type="number" min="0">
        <label><input type="checkbox" name="published"> Published</label>
        <button class="button" type="submit">Create</button>
      </form>
    </div>

    <div class="card"><h3>My Orders</h3>
      <table class="table" id="orders"><thead><tr><th>ID</th><th>Total</th><th>Status</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="card"><h3>Admin Stats</h3>
      <pre id="stats" style="white-space:pre-wrap"></pre>
    </div>
  </div>
</div>
<script type="module">
  import { api, Auth } from '/scripts/api.js';
  import { money } from '/scripts/api.js';
  const who = document.getElementById('who');
  const admin = document.getElementById('admin');
  try{
    const me = await Auth.me();
    who.textContent = `Signed in as ${me.email} — role: ${me.role}`;
    admin.classList.remove('hidden');

    document.getElementById('create').onsubmit = async (e)=>{
      e.preventDefault(); const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      payload.published = !!fd.get('published');
      payload.price_cents = Number(payload.price_cents||0);
      const path = payload.kind==='service'?'/services':'/products';
      try{ await api(path, { method:'POST', body: JSON.stringify(payload) }); alert('Created'); e.target.reset(); }
      catch(err){ alert(err.message); }
    };

    const orders = await api('/orders', { method:'GET' });
    const tbody = document.querySelector('#orders tbody');
    (orders||[]).forEach(o=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${o.id.slice(0,8)}…</td><td>${money(o.total_cents)}</td><td>${o.status}</td>`;
      tbody.appendChild(tr);
    });

    if (me.role==='admin'){
      const s = await api('/admin/stats');
      document.getElementById('stats').textContent = JSON.stringify(s, null, 2);
    }

  }catch(e){ location.href = '/login.html'; }

  document.getElementById('logout').onclick = async()=>{ await Auth.logout(); location.href='/'; };
</script>
</body></html>
