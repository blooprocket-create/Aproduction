<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Control Panel â€” A.Production (of sorts)</title>
<link rel="stylesheet" href="/styles/base.css"><link rel="stylesheet" href="/styles/components.css">
<script defer src="/_vercel/speed-insights/script.js"></script>
<script defer src="/_vercel/insights/script.js"></script>
<style>
  .grid { display:grid; gap:16px; grid-template-columns: 1fr; }
  @media (min-width: 900px){ .grid{ grid-template-columns: 1fr 1fr; } }
  table { width:100%; border-collapse: collapse; }
  th,td { padding:8px 10px; border-bottom: 1px solid rgba(255,255,255,.06); vertical-align: top; }
  .pill { padding:.2rem .5rem; border-radius: 999px; background: rgba(255,255,255,.08); font-size: .85rem; }
  .row-actions { display:flex; gap:8px; flex-wrap: wrap; }
</style>
</head><body>
  <div class="container">
    <nav class="nav" id="nav"></nav>
    <main class="content">
      <h1>Control Panel</h1>

      <section class="grid">
        <section class="card">
          <h3>Service Requests</h3>
          <p class="muted">Quote, mark paid, and deliver files.</p>
          <div id="sr-wrap">
            <table id="sr-table">
              <thead>
                <tr><th>When</th><th>Service</th><th>Customer</th><th>Status</th><th>Quote</th><th>Actions</th></tr>
              </thead>
              <tbody id="sr-body"></tbody>
            </table>
          </div>
        </section>
      </section>
    </main>
  </div>

<script type="module">
  import { currentUser, Service, money } from '/scripts/api.js';
  import { wireNav } from '/scripts/nav.js';

  const me = await currentUser();
  await wireNav('nav-control');
  if (!me || !['admin','editor'].includes(me.role)) {
    document.body.innerHTML = '<div class="container"><main class="content"><h2>Forbidden</h2></main></div>';
    throw new Error('forbidden');
  }

  const tbody = document.getElementById('sr-body');

  async function load(){
    const rows = await Service.adminRequests();
    tbody.innerHTML = '';
    for (const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td>${r.service_title}</td>
        <td>${r.customer_email||''}</td>
        <td><span class="pill">${r.status}</span></td>
        <td>${r.price_cents != null ? money(r.price_cents) : '-'}</td>
        <td class="row-actions"></td>
      `;
      const actions = tr.querySelector('.row-actions');

      if (r.status === 'submitted' || r.status === 'quoted'){
        const quote = document.createElement('form');
        quote.innerHTML = \`
          <input name="price" type="number" min="0" step="1" placeholder="Price (cents)" style="width:140px">
          <button class="button small" type="submit">\${r.status==='quoted'?'Update quote':'Quote'}</button>\`;
        quote.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const price_cents = parseInt(quote.price.value || '0', 10);
          await Service.quote(r.id, price_cents);
          await load();
        });
        actions.appendChild(quote);
      }

      if (r.status === 'accepted' || r.status === 'quoted'){
        const paid = document.createElement('button');
        paid.className = 'button small';
        paid.textContent = 'Mark Paid';
        paid.onclick = async ()=>{ await Service.markPaid(r.id); await load(); };
        actions.appendChild(paid);
      }

      if (r.status === 'paid' || r.status === 'delivered'){
        const deliv = document.createElement('form');
        deliv.innerHTML = \`
          <input name="label" placeholder="Label" required style="width:140px">
          <input name="url" placeholder="https://file-url" required style="width:220px">
          <button class="button small" type="submit">Deliver</button>\`;
        deliv.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const label = deliv.label.value.trim();
          const file_key = deliv.url.value.trim();
          await Service.deliver(r.id, { label, file_key });
          await load();
        });
        actions.appendChild(deliv);
      }

      tbody.appendChild(tr);
    }
  }

  await load();
</script>
<script type="module" src="/scripts/nav.js"></script>
</body></html>
