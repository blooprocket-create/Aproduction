<!doctype html><html><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Control Panel - A.Production (of sorts)</title>
<link rel="stylesheet" href="/styles/base.css"><link rel="stylesheet" href="/styles/components.css">
<script defer src="/_vercel/speed-insights/script.js"></script>
<script defer src="/_vercel/insights/script.js"></script>
<style>
  .cp-layout{display:grid;grid-template-columns:220px 1fr;gap:24px;min-height:70vh}
  .cp-sidebar{background:var(--panel);border-radius:var(--radius);padding:18px;border:1px solid #1f2030;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px}
  .cp-nav-item{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:12px;background:transparent;border:1px solid #26293b;color:var(--muted);font-weight:600;text-align:left;cursor:pointer;transition:background .2s ease,color .2s ease,border-color .2s ease}
  .cp-nav-item.active,.cp-nav-item:hover{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border-color:transparent}
  .cp-main{display:flex;flex-direction:column;gap:24px}
  .panel{display:none;background:var(--panel);border-radius:var(--radius);padding:24px;border:1px solid #1f2030;box-shadow:var(--shadow)}
  .panel.active{display:block}
  .panel h2{margin-top:0}
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:18px}
  .stats-grid .metric{min-height:120px}
  .table-wrap{overflow:auto}
  .cp-forms{display:grid;gap:18px}
  .cp-forms form{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
  .cp-forms button{justify-self:start}
  @media(max-width:960px){.cp-layout{grid-template-columns:1fr}.cp-sidebar{flex-direction:row;overflow:auto}.cp-nav-item{flex:1;justify-content:center}}
</style>
</head><body>
<div class="container">
  <nav class="nav" id="nav">
    <div class="brand">
      <span class="logo">
        <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="g1" x1="0" x2="1"><stop offset="0%" stop-color="#8a7cff"/><stop offset="100%" stop-color="#e45aff"/></linearGradient>
            <radialGradient id="g2" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#e45aff"/><stop offset="100%" stop-color="#8a7cff"/></radialGradient>
          </defs>
          <circle class="ring" cx="20" cy="20" r="14" />
          <circle class="dot" cx="28" cy="12" r="3"/>
        </svg>
      </span>
      <span class="badge">A.Production</span><span class="muted" style="margin-left:8px">(of sorts)</span>
    </div>
    <button class="nav-toggle" id="nav-toggle" aria-label="Menu"></button>
    <div class="nav-links" id="nav-links">
      <a href="/index.html" id="nav-home">Home</a>
      <a href="/services.html" id="nav-services">Services</a>
      <a href="/products.html" id="nav-products">Products</a>
      <a href="/account.html" id="nav-account">Account</a>
      <a href="/control-panel.html" id="nav-control">Control</a>
      <a href="/login.html" id="nav-login">Login</a>
      <a href="#" id="nav-logout">Logout</a>
    </div>
  </nav>
  <h1>Control Panel</h1>
  <div id="who" class="muted"></div>
  <div class="cp-layout" id="cp-layout" hidden>
    <aside class="cp-sidebar" id="cp-nav">
      <button class="cp-nav-item active" data-tab="stats">Stats</button>
      <button class="cp-nav-item" data-tab="products">Products</button>
      <button class="cp-nav-item" data-tab="users">Users</button>
      <button class="cp-nav-item" data-tab="requests">Service Requests</button>
    </aside>
    <main class="cp-main">
      <section class="panel active" id="panel-stats">
        <h2>Site Stats</h2>
        <div class="stats-grid">
          <div class="metric"><h4>Users</h4><div class="val" id="stat-users">—</div></div>
          <div class="metric"><h4>Published Products</h4><div class="val" id="stat-published">—</div></div>
          <div class="metric"><h4>Sales</h4><div class="val" id="stat-orders">—</div></div>
          <div class="metric"><h4>Revenue</h4><div class="val" id="stat-revenue">—</div></div>
        </div>
      </section>
      <section class="panel" id="panel-products">
        <h2>Products</h2>
        <div class="cp-forms">
          <form id="product-create">
            <select name="kind">
              <option value="product">Product</option>
              <option value="course">Course</option>
              <option value="service">Service</option>
            </select>
            <input class="input" name="slug" placeholder="Slug" required>
            <input class="input" name="title" placeholder="Title" required>
            <textarea class="input" name="description" placeholder="Description"></textarea>
            <input class="input" name="price" type="number" min="0" step="0.01" placeholder="Price in USD" required>
            <label><input type="checkbox" name="published"> Published</label>
            <button class="button" type="submit">Create</button>
          </form>
        </div>
        <div class="table-wrap">
          <table class="table" id="products-table">
            <thead>
              <tr><th>Kind</th><th>Title</th><th>Slug</th><th>Price</th><th>Published</th><th>ID</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      <section class="panel" id="panel-users">
        <h2>Users</h2>
        <div class="cp-forms">
          <form id="user-create">
            <input class="input" name="email" placeholder="Email" type="email" required>
            <input class="input" name="password" placeholder="Password" type="password" required>
            <select name="role">
              <option value="customer">Customer</option>
              <option value="editor">Editor</option>
              <option value="admin">Admin</option>
            </select>
            <button class="button" type="submit">Invite User</button>
          </form>
        </div>
        <div class="table-wrap">
          <table class="table" id="users-table">
            <thead>
              <tr><th>Email</th><th>Role</th><th>Created</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      <section class="panel" id="panel-requests">
        <h2>Service Requests</h2>
        <div class="table-wrap">
          <table class="table requests-table">
            <thead>
              <tr>
                <th>Created</th>
                <th>Service</th>
                <th>Customer</th>
                <th>Status</th>
                <th>Quote</th>
                <th style="width:320px">Actions</th>
              </tr>
            </thead>
            <tbody id="requests-body"></tbody>
          </table>
        </div>
        <p id="requests-empty" class="muted hidden">No active requests yet.</p>
      </section>
    </main>
  </div>
</div>
<script type="module">
  import { api, Auth, money, Service } from '/scripts/api.js';
  import { wireNav } from '/scripts/nav.js';

  await wireNav('nav-control');

  const state = {
    me: null,
    currentTab: 'stats',
    canDeleteProducts: false,
  };

  const layout = document.getElementById('cp-layout');
  const who = document.getElementById('who');
  const navButtons = Array.from(document.querySelectorAll('.cp-nav-item'));
  const panels = {
    stats: document.getElementById('panel-stats'),
    products: document.getElementById('panel-products'),
    users: document.getElementById('panel-users'),
    requests: document.getElementById('panel-requests'),
  };

  const productsTable = document.querySelector('#products-table tbody');
  const usersTable = document.querySelector('#users-table tbody');
  const requestsBody = document.getElementById('requests-body');
  const requestsEmpty = document.getElementById('requests-empty');

  const loaders = {
    stats: loadStats,
    products: loadProducts,
    users: loadUsers,
    requests: loadRequests,
  };

  navButtons.forEach((btn) => {
    btn.addEventListener('click', () => activateTab(btn.dataset.tab));
  });

  const productForm = document.getElementById('product-create');
  productForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const fd = new FormData(productForm);
    const payload = Object.fromEntries(fd.entries());
    payload.published = !!fd.get('published');
    payload.price_cents = Math.round(Number(payload.price || 0) * 100);
    delete payload.price;
    const path = payload.kind === 'service' ? '/services' : '/products';
    try {
      await api(path, { method: 'POST', body: JSON.stringify(payload) });
      productForm.reset();
      await loadProducts();
      if (state.currentTab === 'requests') await loadRequests();
    } catch (error) {
      alert(error.message);
    }
  });

  const userForm = document.getElementById('user-create');
  userForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const fd = new FormData(userForm);
    const payload = Object.fromEntries(fd.entries());
    try {
      await api('/admin/users', { method: 'POST', body: JSON.stringify(payload) });
      userForm.reset();
      await loadUsers();
    } catch (error) {
      alert(error.message);
    }
  });

  init();

  async function init(){
    try {
      state.me = await Auth.me();
    } catch {
      location.href = '/login.html';
      return;
    }
    if (!state.me || !['admin','editor'].includes(state.me.role)) {
      location.href = '/';
      return;
    }
    who.textContent = `Signed in as ${state.me.email} — role: ${state.me.role}`;
    state.canDeleteProducts = state.me.role === 'admin';
    layout.hidden = false;
    await activateTab('stats');
  }

  async function activateTab(tab){
    state.currentTab = tab;
    navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
    Object.entries(panels).forEach(([key, panel]) => {
      panel.classList.toggle('active', key === tab);
    });
    const loader = loaders[tab];
    if (loader) await loader();
  }

  async function loadStats(){
    try {
      const stats = await api('/admin/stats');
      document.getElementById('stat-users').textContent = Number(stats.users || 0).toLocaleString();
      document.getElementById('stat-published').textContent = Number(stats.published || 0).toLocaleString();
      document.getElementById('stat-orders').textContent = Number(stats.orders || 0).toLocaleString();
      document.getElementById('stat-revenue').textContent = money(stats.revenue_cents || 0);
    } catch (error) {
      alert(error.message);
    }
  }

  async function loadProducts(){
    try {
      const [products, services] = await Promise.all([
        api('/products?all=1'),
        api('/services?all=1'),
      ]);
      const rows = [...(products || []), ...(services || [])];
      productsTable.innerHTML = '';
      rows.forEach(row => productsTable.appendChild(renderProductRow(row)));
    } catch (error) {
      productsTable.innerHTML = '';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="7">${error.message || 'Unable to load products'}</td>`;
      productsTable.appendChild(tr);
    }
  }

  function renderProductRow(row){
    const tr = document.createElement('tr');
    tr.dataset.id = row.id;
    tr.dataset.kind = row.kind;
    tr.innerHTML = `
      <td>${(row.kind || '').toUpperCase()}</td>
      <td class="cell" data-field="title">${row.title}</td>
      <td class="cell" data-field="slug">${row.slug}</td>
      <td class="cell" data-field="price_cents">${money(row.price_cents)}</td>
      <td class="cell" data-field="published">${row.published ? 'Yes' : 'No'}</td>
      <td>${row.id.slice(0,8)}...</td>
      <td class="catalog-actions"></td>`;
    const actions = tr.querySelector('.catalog-actions');
    const edit = document.createElement('a');
    edit.href = '#';
    edit.className = 'pill act-edit';
    edit.textContent = 'Edit';
    edit.addEventListener('click', (event) => {
      event.preventDefault();
      enterProductEdit(tr, row);
    });
    actions.appendChild(edit);
    if (state.canDeleteProducts) {
      const remove = document.createElement('a');
      remove.href = '#';
      remove.className = 'pill';
      remove.textContent = 'Delete';
      remove.style.marginLeft = '8px';
      remove.addEventListener('click', (event) => {
        event.preventDefault();
        deleteProduct(row);
      });
      actions.appendChild(remove);
    }
    return tr;
  }

  function enterProductEdit(tr, row){
    const cells = tr.querySelectorAll('.cell');
    cells.forEach(td => {
      const field = td.dataset.field;
      if (field === 'published') {
        td.innerHTML = `<div class="cell-edit"><input type="checkbox" ${row.published ? 'checked' : ''}></div>`;
      } else if (field === 'price_cents') {
        td.innerHTML = `<div class="cell-edit"><input type="number" min="0" step="0.01" value="${(row.price_cents || 0)/100}"></div>`;
      } else {
        td.innerHTML = `<div class="cell-edit"><input type="text" value="${row[field] || ''}"></div>`;
      }
    });
    const actions = tr.querySelector('.catalog-actions');
    actions.innerHTML = '';
    const save = document.createElement('a');
    save.href = '#';
    save.className = 'pill act-save';
    save.textContent = 'Save';
    const cancel = document.createElement('a');
    cancel.href = '#';
    cancel.className = 'pill act-cancel';
    cancel.textContent = 'Cancel';
    actions.appendChild(save);
    actions.appendChild(cancel);

    const submit = async () => {
      const payload = {};
      tr.querySelectorAll('.cell').forEach(td => {
        const field = td.dataset.field;
        const input = td.querySelector('input');
        if (!input) return;
        if (field === 'price_cents') payload[field] = Math.round(Number(input.value || 0) * 100);
        else if (field === 'published') payload[field] = !!input.checked;
        else payload[field] = input.value;
      });
      try {
        const base = row.kind === 'service' ? '/services' : '/products';
        await api(`${base}/${row.id}`, { method:'PATCH', body: JSON.stringify(payload) });
        const fresh = await api(`${base}/${row.id}`);
        tr.replaceWith(renderProductRow(fresh));
      } catch (error) {
        alert(error.message);
      }
    };

    save.addEventListener('click', (event) => { event.preventDefault(); submit(); });
    cancel.addEventListener('click', async (event) => { event.preventDefault(); await loadProducts(); });
  }

  async function deleteProduct(row){
    if (!window.confirm(`Delete ${row.title}? This cannot be undone.`)) return;
    const base = row.kind === 'service' ? '/services' : '/products';
    try {
      await api(`${base}/${row.id}`, { method:'DELETE' });
      await loadProducts();
      if (state.currentTab === 'requests') await loadRequests();
    } catch (error) {
      alert(error.message);
    }
  }

  async function loadUsers(){
    try {
      const users = await api('/admin/users');
      usersTable.innerHTML = '';
      users.forEach(user => usersTable.appendChild(renderUserRow(user)));
    } catch (error) {
      usersTable.innerHTML = `<tr><td colspan="4">${error.message || 'Unable to load users'}</td></tr>`;
    }
  }

  function renderUserRow(user){
    const tr = document.createElement('tr');
    tr.dataset.id = user.id;
    tr.innerHTML = `
      <td>${user.email}</td>
      <td>
        <select class="input" data-role>
          <option value="customer" ${user.role==='customer'?'selected':''}>Customer</option>
          <option value="editor" ${user.role==='editor'?'selected':''}>Editor</option>
          <option value="admin" ${user.role==='admin'?'selected':''}>Admin</option>
        </select>
      </td>
      <td>${formatDate(user.created_at)}</td>
      <td class="request-actions"></td>`;
    const actions = tr.querySelector('.request-actions');

    const save = document.createElement('button');
    save.className = 'button ghost';
    save.textContent = 'Save';
    save.addEventListener('click', () => updateUser(tr));
    actions.appendChild(save);

    if (user.id !== state.me?.sub) {
      const del = document.createElement('button');
      del.className = 'button ghost';
      del.textContent = 'Delete';
      del.addEventListener('click', () => deleteUser(user.id));
      actions.appendChild(del);
    } else {
      const note = document.createElement('span');
      note.className = 'muted';
      note.textContent = 'Cannot delete self';
      actions.appendChild(note);
    }

    return tr;
  }

  async function updateUser(row){
    const id = row.dataset.id;
    const role = row.querySelector('[data-role]').value;
    try {
      await api(`/admin/users/${id}`, { method:'PATCH', body: JSON.stringify({ role }) });
      await loadUsers();
    } catch (error) {
      alert(error.message);
    }
  }

  async function deleteUser(id){
    if (!window.confirm('Delete this user?')) return;
    try {
      await api(`/admin/users/${id}`, { method:'DELETE' });
      await loadUsers();
    } catch (error) {
      alert(error.message);
    }
  }

  async function loadRequests(){
    try {
      const rows = await Service.adminRequests();
      requestsBody.innerHTML = '';
      if (!rows || !rows.length){
        requestsEmpty.classList.remove('hidden');
        return;
      }
      requestsEmpty.classList.add('hidden');
      rows.forEach(row => requestsBody.appendChild(renderRequestRow(row)));
    } catch (error) {
      requestsBody.innerHTML = '';
      requestsEmpty.textContent = error.message || 'Unable to load requests';
      requestsEmpty.classList.remove('hidden');
    }
  }

  function renderRequestRow(row){
    const tr = document.createElement('tr');
    tr.className = `status-${(row.status || '').toLowerCase()}`;
    tr.innerHTML = `
      <td>${formatDate(row.created_at)}</td>
      <td>${row.service_title}</td>
      <td>${row.customer_email || ''}</td>
      <td>${row.status}</td>
      <td>${row.price_cents != null ? money(row.price_cents) : '-'}</td>
      <td class="request-actions"></td>`;
    const actions = tr.querySelector('.request-actions');

    if (row.status === 'submitted' || row.status === 'quoted') {
      const form = document.createElement('form');
      form.innerHTML = `
        <input name="price" type="number" min="0" step="1" placeholder="Price (cents)" class="input">
        <button class="button small">Send Quote</button>`;
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const cents = Number.parseInt(form.price.value || '0', 10);
        await Service.quote(row.id, Math.max(0, cents));
        await loadRequests();
      });
      actions.appendChild(form);
    }

    if (row.status === 'accepted' || row.status === 'quoted') {
      const paidBtn = document.createElement('button');
      paidBtn.type = 'button';
      paidBtn.className = 'button small ghost';
      paidBtn.textContent = 'Mark Paid';
      paidBtn.addEventListener('click', async () => {
        await Service.markPaid(row.id);
        await loadRequests();
      });
      actions.appendChild(paidBtn);
    }

    if (row.status === 'paid' || row.status === 'delivered') {
      const deliverForm = document.createElement('form');
      deliverForm.innerHTML = `
        <input name="label" class="input" placeholder="Deliverable label" required>
        <input name="url" class="input" placeholder="https://file-url" required>
        <button class="button small">Deliver</button>`;
      deliverForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const label = deliverForm.label.value.trim();
        const url = deliverForm.url.value.trim();
        if (!label || !url) return;
        await Service.deliver(row.id, { label, file_key: url });
        deliverForm.reset();
        await loadRequests();
      });
      actions.appendChild(deliverForm);
    }

    return tr;
  }

  function formatDate(date){
    if (!date) return '—';
    try { return new Date(date).toLocaleString(); }
    catch { return date; }
  }
</script>
<script type="module" src="/scripts/nav.js"></script>
</body></html>

