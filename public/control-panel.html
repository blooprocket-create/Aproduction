<!doctype html><html><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Control Panel — A.Production (of sorts)</title>
<link rel="stylesheet" href="/styles/base.css"><link rel="stylesheet" href="/styles/components.css">
</head><body><div class="container">
  <nav class="nav">
    <div class="row"><span class="badge">A.Production</span><span class="muted" style="margin-left:8px">(of sorts)</span></div>
    <div>
      <a href="/index.html" id="nav-home">Home</a>
      <a href="/services.html" id="nav-services">Services</a>
      <a href="/products.html" id="nav-products">Products</a>
      <a href="/account.html" id="nav-account">Account</a>
      <a href="/control-panel.html" id="nav-control">Control</a>
      <a href="/login.html" id="nav-login">Login</a>
      <a href="#" id="nav-logout">Logout</a>
    </div>
  </nav>
  <h1>Control Panel</h1>
  <div id="who" class="muted"></div>

  <div id="admin" class="grid hidden">
    <div class="metrics" id="metrics">
      <div class="metric"><h4>Users</h4><div class="val" id="m-users">—</div></div>
      <div class="metric"><h4>Published</h4><div class="val" id="m-published">—</div></div>
      <div class="metric"><h4>Revenue</h4><div class="val" id="m-revenue">—</div></div>
    </div>

    <div class="card"><h3>Create Product/Service</h3>
      <form id="create" class="grid">
        <select name="kind"><option value="product">Product</option><option value="course">Course</option><option value="service">Service</option></select>
        <input class="input" name="slug" placeholder="slug" required>
        <input class="input" name="title" placeholder="title" required>
        <textarea class="input" name="description" placeholder="description"></textarea>
        <input class="input" name="price" placeholder="price in USD (e.g. 99.00)" type="number" min="0" step="0.01" required>
        <label><input type="checkbox" name="published"> Published</label>
        <button class="button" type="submit">Create</button>
      </form>
    </div>

    <div class="card" style="grid-column: span 2;">
      <h3>Catalog</h3>
      <table class="table" id="catalog">
        <thead><tr><th>Kind</th><th>Title</th><th>Slug</th><th>Price</th><th>Published</th><th>ID</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
<script type="module">
  import { api, Auth, money } from '/scripts/api.js';
  import { wireNav } from '/scripts/nav.js';
  await wireNav('nav-control');

  const who = document.getElementById('who');
  const admin = document.getElementById('admin');
  try{
    const me = await Auth.me();
    if (!['admin','editor'].includes(me.role)) { location.href='/'; }
    who.textContent = `Signed in as ${me.email} — role: ${me.role}`;
    admin.classList.remove('hidden');

    if (me.role==='admin'){
      const s = await api('/admin/stats');
      const users = Number(s.users||0);
      const published = Number(s.published||0);
      const revenue = Number(s.revenue_cents||0);
      document.getElementById('m-users').textContent = users.toLocaleString();
      document.getElementById('m-published').textContent = published.toLocaleString();
      document.getElementById('m-revenue').textContent = money(revenue);
    }

    document.getElementById('create').onsubmit = async (e)=>{
      e.preventDefault(); const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      payload.published = !!fd.get('published');
      payload.price_cents = Math.round(Number(payload.price||0)*100);
      delete payload.price;
      const path = payload.kind==='service'?'/services':'/products';
      try{ await api(path, { method:'POST', body: JSON.stringify(payload) }); e.target.reset(); await loadCatalog(); }
      catch(err){ alert(err.message); }
    };

    async function loadCatalog(){
      const [prods, servs] = await Promise.all([ api('/products?all=1'), api('/services?all=1') ]);
      const rows = [...(prods||[]), ...(servs||[])];
      const tb = document.querySelector('#catalog tbody');
      tb.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const kind = (r.kind||'').toUpperCase();
        tr.innerHTML = `<td>${kind}</td><td>${r.title}</td><td>${r.slug}</td><td>${money(r.price_cents)}</td><td>${r.published?'Yes':'No'}</td><td>${r.id.slice(0,8)}…</td>
                        <td><a class="edit-pill" href="/edit.html?id=${r.id}&k=${r.kind==='service'?'service':'product'}">Edit</a></td>`;
        tb.appendChild(tr);
      });
    }
    await loadCatalog();

  }catch(e){ location.href = '/login.html'; }
</script>
</body></html>
