<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Service Requests — A.Production (of sorts)</title>
<link rel="stylesheet" href="/styles/base.css"><link rel="stylesheet" href="/styles/components.css">
<style>
  .container { min-height: 100vh; }
  table { width:100%; border-collapse: collapse; }
  th,td { padding:8px 10px; border-bottom: 1px solid rgba(255,255,255,.08); text-align:left; }
  .muted { opacity:.8 }
  .row-actions { display:flex; gap:8px; flex-wrap: wrap; }
  pre { background: rgba(255,255,255,.05); padding: 10px; border-radius: 12px; overflow:auto; }
  .diag { margin: 12px 0; }
  .small { font-size: .9rem; padding: .4rem .6rem; }
</style>
</head><body>
<div class="container">
  <nav class="nav" id="nav">
    <div class="brand"><span class="badge">A.Production</span><span class="muted" style="margin-left:8px">(of sorts)</span></div>
    <div class="nav-links"><a href="/control-panel.html">Control</a></div>
  </nav>
  <main class="content">
    <h1>Service Requests</h1>
    <p class="muted">Quote, mark paid, and deliver files.</p>

    <div class="diag">
      <h4>Diagnostics</h4>
      <div>Current user (/api/auth/me):</div>
      <pre id="who">…</pre>
      <div>Admin list payload (/api/services?admin=1):</div>
      <pre id="raw">…</pre>
      <div id="err" class="muted"></div>
    </div>

    <table id="tbl">
      <thead>
        <tr><th>When</th><th>Service</th><th>Customer</th><th>Status</th><th>Quote</th><th>Actions</th></tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </main>
</div>

<script>
  const money = (c) => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format((+c||0)/100);

  async function safeJSON(path, init={}){
    const res = await fetch(path, { credentials:'include', ...init });
    const text = await res.text();
    try { return { ok: res.ok, status: res.status, data: JSON.parse(text), text }; }
    catch { return { ok: res.ok, status: res.status, data: null, text }; }
  }

  (async function main(){
    const who = document.getElementById('who');
    const raw = document.getElementById('raw');
    const err = document.getElementById('err');
    const tbody = document.getElementById('rows');

    const meRes = await safeJSON('/api/auth/me');
    who.textContent = meRes.text;
    const me = meRes.data && (meRes.data.data ?? meRes.data);
    if (!me || !['admin','editor'].includes(me.role)) {
      document.querySelector('main').innerHTML = '<h2>Forbidden (not admin/editor)</h2><pre>'+who.textContent+'</pre>';
      return;
    }

    const adminRes = await safeJSON('/api/services?admin=1');
    raw.textContent = adminRes.text;

    let rows = [];
    if (adminRes.data) rows = adminRes.data.data ?? adminRes.data;
    if (!Array.isArray(rows)) rows = [];

    function rerender(){
      tbody.innerHTML='';
      if (!rows.length){
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" class="muted">No requests yet.</td>';
        tbody.appendChild(tr);
        return;
      }
      for (const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.created_at ? new Date(r.created_at).toLocaleString() : '-'}</td>
          <td>${r.service_title || '-'}</td>
          <td>${r.customer_email || '-'}</td>
          <td>${r.status || '-'}</td>
          <td>${r.price_cents!=null ? money(r.price_cents) : '-'}</td>
          <td class="row-actions"></td>`;
        const act = tr.querySelector('.row-actions');

        if (r.status==='submitted' || r.status==='quoted'){
          const f = document.createElement('form');
          f.innerHTML = '<input name="price" type="number" min="0" step="1" placeholder="Price (cents)" style="width:140px"> <button class="button small">Quote</button>';
          f.onsubmit = async (e)=>{
            e.preventDefault();
            const price_cents = parseInt(f.price.value||'0',10);
            const res = await safeJSON(`/api/services/${r.id}`, { method:'PATCH', headers:{'content-type':'application/json'}, body: JSON.stringify({ op:'quote', request_id: r.id, price_cents }) });
            if (!res.ok){ err.textContent = res.text; return; }
            const updated = (res.data && (res.data.data ?? res.data)) || {};
            Object.assign(r, updated);
            rerender();
          };
          act.appendChild(f);
        }

        if (r.status==='accepted' || r.status==='quoted'){
          const b = document.createElement('button');
          b.className='button small'; b.textContent='Mark Paid';
          b.onclick = async ()=>{
            const res = await safeJSON(`/api/services/${r.id}`, { method:'PATCH', headers:{'content-type':'application/json'}, body: JSON.stringify({ op:'paid', request_id: r.id }) });
            if (!res.ok){ err.textContent = res.text; return; }
            const updated = (res.data && (res.data.data ?? res.data)) || {};
            Object.assign(r, updated);
            rerender();
          };
          act.appendChild(b);
        }

        if (r.status==='paid' || r.status==='delivered'){
          const f2 = document.createElement('form');
          f2.innerHTML = '<input name="label" placeholder="Label" required style="width:140px"> <input name="url" placeholder="https://file-url" required style="width:220px"> <button class="button small">Deliver</button>';
          f2.onsubmit = async (e)=>{
            e.preventDefault();
            const label = f2.label.value.trim();
            const file_key = f2.url.value.trim();
            const res = await safeJSON(`/api/services/${r.id}`, { method:'PATCH', headers:{'content-type':'application/json'}, body: JSON.stringify({ op:'deliver', request_id: r.id, label, file_key }) });
            if (!res.ok){ err.textContent = res.text; return; }
            const updated = (res.data && (res.data.data ?? res.data)) || {};
            Object.assign(r, updated);
            rerender();
          };
          act.appendChild(f2);
        }

        tbody.appendChild(tr);
      }
    }

    rerender();
  })();
</script>
</body></html>
