<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Service Requests - A.Production (of sorts)</title>
<link rel="stylesheet" href="/styles/base.css"><link rel="stylesheet" href="/styles/components.css">
<script defer src="/_vercel/speed-insights/script.js"></script>
<script defer src="/_vercel/insights/script.js"></script>
</head><body>
  <div class="container">
    <nav class="nav" id="nav">
      <div class="brand">
        <span class="logo">
          <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="g1" x1="0" x2="1"><stop offset="0%" stop-color="#8a7cff"/><stop offset="100%" stop-color="#e45aff"/></linearGradient>
              <radialGradient id="g2" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#e45aff"/><stop offset="100%" stop-color="#8a7cff"/></radialGradient>
            </defs>
            <circle class="ring" cx="20" cy="20" r="14" />
            <circle class="dot" cx="28" cy="12" r="3"/>
          </svg>
        </span>
        <span class="badge">A.Production</span><span class="muted" style="margin-left:8px">(of sorts)</span>
      </div>
      <button class="nav-toggle" id="nav-toggle" aria-label="Menu"></button>
      <div class="nav-links" id="nav-links">
        <a href="/index.html" id="nav-home">Home</a>
        <a href="/services.html" id="nav-services">Services</a>
        <a href="/products.html" id="nav-products">Products</a>
        <a href="/account.html" id="nav-account">Account</a>
        <a href="/control-panel.html" id="nav-control">Control</a>
        <a href="/login.html" id="nav-login">Login</a>
        <a href="#" id="nav-logout">Logout</a>
      </div>
    </nav>
    <main class="card" style="overflow:auto">
      <h1>Service Requests</h1>
      <p class="muted">Quote, mark paid, or deliver assets for in-flight client requests.</p>
      <div class="table-wrap" style="margin-top:18px">
        <table class="table">
          <thead>
            <tr>
              <th>Created</th>
              <th>Service</th>
              <th>Customer</th>
              <th>Status</th>
              <th>Quoted</th>
              <th style="width:320px">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <p id="empty" class="muted hidden">No requests yet. Once customers submit a brief you will see it here.</p>
    </main>
  </div>
<script type="module">
  import { currentUser, Service, money } from '/scripts/api.js';
  import { wireNav } from '/scripts/nav.js';

  const me = await currentUser();
  await wireNav('nav-control');
  if (!me || !['admin','editor'].includes(me.role)) {
    document.body.innerHTML = '<div class="container"><main class="card"><h2>Forbidden</h2><p class="muted">You need admin or editor access to view service requests.</p></main></div>';
    throw new Error('forbidden');
  }

  const tbody = document.getElementById('rows');
  const emptyState = document.getElementById('empty');

  async function load() {
    const rows = await Service.adminRequests();
    tbody.innerHTML = '';
    if (!rows.length) {
      emptyState.classList.remove('hidden');
      return;
    }
    emptyState.classList.add('hidden');
    rows.forEach((row) => tbody.appendChild(renderRow(row)));
  }

  function renderRow(row) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(row.created_at).toLocaleString()}</td>
      <td>${row.service_title}</td>
      <td>${row.customer_email || ''}</td>
      <td>${row.status}</td>
      <td>${row.price_cents != null ? money(row.price_cents) : '-'}</td>
      <td class="act" style="display:flex;flex-direction:column;gap:8px"></td>`;

    const act = tr.querySelector('.act');

    if (row.status === 'submitted' || row.status === 'quoted') {
      const quoteForm = document.createElement('form');
      quoteForm.className = 'row';
      quoteForm.style.gap = '8px';
      quoteForm.innerHTML = `
        <input name="price" type="number" min="0" step="1" placeholder="Price (cents)" class="input" style="max-width:140px">
        <button class="button" style="padding:10px 16px">Send Quote</button>`;
      quoteForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const cents = Number.parseInt(quoteForm.price.value || '0', 10);
        await Service.quote(row.id, Math.max(0, cents));
        await load();
      });
      act.appendChild(quoteForm);
    }

    if (row.status === 'accepted' || row.status === 'quoted') {
      const paidBtn = document.createElement('button');
      paidBtn.className = 'button ghost';
      paidBtn.textContent = 'Mark Paid';
      paidBtn.addEventListener('click', async () => {
        await Service.markPaid(row.id);
        await load();
      });
      act.appendChild(paidBtn);
    }

    if (row.status === 'paid' || row.status === 'delivered') {
      const deliverForm = document.createElement('form');
      deliverForm.className = 'grid';
      deliverForm.style.gap = '8px';
      deliverForm.innerHTML = `
        <input name="label" class="input" placeholder="Deliverable label" required>
        <input name="url" class="input" placeholder="https://file-url" required>
        <button class="button" style="padding:10px 16px">Deliver</button>`;
      deliverForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const label = deliverForm.label.value.trim();
        const url = deliverForm.url.value.trim();
        if (!label || !url) return;
        await Service.deliver(row.id, { label, file_key: url });
        deliverForm.reset();
        await load();
      });
      act.appendChild(deliverForm);
    }

    return tr;
  }

  await load();
</script>
<script type="module" src="/scripts/nav.js"></script>
</body></html>
