<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>My Service Requests — A.Production (of sorts)</title>
<link rel="stylesheet" href="/styles/base.css"><link rel="stylesheet" href="/styles/components.css">
<style>
  .container { min-height: 100vh; }
  .card { margin-bottom: 16px; }
  .muted { opacity:.85 }
  .pill { padding:.2rem .5rem; border-radius:999px; background: rgba(255,255,255,.08); font-size:.85rem }
  .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
  .grid { display:grid; gap:16px; grid-template-columns: 1fr; }
  @media (min-width: 900px){ .grid{ grid-template-columns: 1fr 1fr; } }
  .actions { display:flex; gap:8px; flex-wrap: wrap; }
  .downloads a { color: #cdb4ff; }
  .small { font-size:.9rem; padding:.45rem .7rem; }
  pre { background: rgba(255,255,255,.05); padding: 10px; border-radius: 12px; overflow:auto; }
  .diag { margin: 12px 0; }
  .err { color: #ff8a8a; white-space: pre-wrap; }
</style>
</head><body>
<div class="container">
  <nav class="nav" id="nav">
    <div class="brand">
      <span class="badge">A.Production</span><span class="muted" style="margin-left:8px">(of sorts)</span>
    </div>
    <div class="nav-links">
      <a href="/index.html">Home</a>
      <a href="/account.html">Account</a>
    </div>
  </nav>

  <main class="content">
    <h1>My Service Requests</h1>
    <p class="muted">Track quotes, accept prices, and download deliverables.</p>

    <div class="diag">
      <h4>Diagnostics</h4>
      <div>Current user (/api/auth/me):</div>
      <pre id="who">…</pre>
      <div>Mine list payload (/api/services?mine=1):</div>
      <pre id="raw">…</pre>
      <div class="err" id="err"></div>
    </div>

    <div id="list" class="grid"></div>
  </main>
</div>

<script>
(function(){
  function money(c){ try{ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format((+c||0)/100); }catch(e){ return '$' + ((+c||0)/100).toFixed(2); } }
  function ce(tag){ return document.createElement(tag); }
  function txt(s){ return document.createTextNode(s); }

  function safeJSON(path, init){
    init = init || {};
    init.credentials = 'include';
    return fetch(path, init).then(function(res){
      return res.text().then(function(text){
        try{ return { ok: res.ok, status: res.status, data: JSON.parse(text), text: text, error: null }; }
        catch(e){ return { ok: res.ok, status: res.status, data: null, text: text, error: null }; }
      });
    }).catch(function(e){
      return { ok:false, status:0, data:null, text:'', error: (e && (e.message||String(e))) || 'Network error' };
    });
  }

  function requestCard(r){
    var el = ce('section'); el.className='card';

    var row1 = ce('div'); row1.className='row'; row1.style.justifyContent='space-between';
    var left = ce('div');
    var meta = ce('div'); meta.className='muted small'; meta.appendChild(txt(r.created_at ? new Date(r.created_at).toLocaleString() : ''));
    var h3 = ce('h3'); h3.style.margin='.25rem 0'; h3.appendChild(txt((r.title || r.service_title || 'Service request')));
    var sub = ce('div'); sub.className='muted'; sub.appendChild(txt(r.service_title || ''));
    left.appendChild(meta); left.appendChild(h3); left.appendChild(sub);
    var pill = ce('div'); pill.className='pill'; pill.appendChild(txt(r.status));

    row1.appendChild(left); row1.appendChild(pill);

    var detailsRow = null;
    if (r.details){
      detailsRow = ce('div'); detailsRow.className='row help'; detailsRow.appendChild(txt(r.details));
    }

    var row2 = ce('div'); row2.className='row'; row2.style.justifyContent='space-between'; row2.style.marginTop='10px';
    var quoted = ce('div'); quoted.className='muted'; quoted.appendChild(txt('Quoted: ' + (r.price_cents!=null ? money(r.price_cents) : '—')));
    var actions = ce('div'); actions.className='actions';
    row2.appendChild(quoted); row2.appendChild(actions);

    var downloads = ce('div'); downloads.className='downloads'; downloads.style.marginTop='12px';

    el.appendChild(row1);
    if (detailsRow) el.appendChild(detailsRow);
    el.appendChild(row2);
    el.appendChild(downloads);

    if (r.status === 'quoted'){
      var b = ce('button'); b.className='button small'; b.appendChild(txt('Accept Quote'));
      b.onclick = function(){
        safeJSON('/api/services/' + r.id, {
          method:'PATCH',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ op:'accept', request_id: r.id })
        }).then(function(res){
          if (!res.ok){ alert(res.text || res.error || 'Failed to accept'); return; }
          var data = res.data && (res.data.data || res.data) || {};
          for (var k in data){ r[k] = data[k]; }
          location.reload();
        });
      };
      actions.appendChild(b);
    }

    if (r.status === 'delivered'){
      var files = (r.deliverables && r.deliverables.length) ? r.deliverables : [];
      downloads.innerHTML = '<h4>Deliverables</h4>';
      if (!files.length){
        var p = ce('p'); p.className='muted'; p.appendChild(txt('Admin marked delivered but no files listed.'));
        downloads.appendChild(p);
      } else {
        var ul = ce('ul'); ul.className='list';
        for (var i=0;i<files.length;i++){
          var d = files[i];
          var li = ce('li'); li.className='row';
          var a = ce('a'); a.target='_blank'; a.rel='noopener'; a.href = d.file_key; a.appendChild(txt(d.label || 'File'));
          li.appendChild(a); ul.appendChild(li);
        }
        downloads.appendChild(ul);
      }
    } else if (r.status === 'paid' || r.status === 'accepted' || r.status === 'quoted') {
      var p2 = ce('p'); p2.className='muted';
      p2.appendChild(txt(r.status==='paid' ? 'Paid. Waiting for delivery.' : (r.status==='accepted' ? 'Accepted. Awaiting delivery.' : 'Awaiting your decision.')));
      downloads.appendChild(p2);
    }

    return el;
  }

  function main(){
    var who = document.getElementById('who');
    var raw = document.getElementById('raw');
    var err = document.getElementById('err');
    var list = document.getElementById('list');

    safeJSON('/api/auth/me').then(function(me){
      who.textContent = me.text || '';
      var user = me.data && (me.data.data || me.data);
      if (!user || !user.id){
        document.querySelector('main').innerHTML = '<h2>Please log in to view your requests.</h2>';
        return;
      }

      safeJSON('/api/services?mine=1').then(function(mine){
        raw.textContent = mine.text || (mine.error || '');
        var rows = mine.data && (mine.data.data || mine.data);
        if (!rows || !rows.length){
          list.innerHTML = '<div class="card"><p class="muted">No service requests yet.</p></div>';
          return;
        }

        // Hydrate each with detail, sequential to keep it simple
        var idx = 0, detailed = [];
        function next(){
          if (idx >= rows.length){
            list.innerHTML = '';
            for (var j=0;j<detailed.length;j++) list.appendChild(requestCard(detailed[j]));
            return;
          }
          var r = rows[idx++];
          safeJSON('/api/services/' + r.id).then(function(det){
            var data = det && det.data && (det.data.data || det.data);
            if (data){ for (var k in data){ r[k] = data[k]; } }
            detailed.push(r);
            next();
          }).catch(function(){ detailed.push(r); next(); });
        }
        next();
      });
    }).catch(function(e){
      err.textContent = e && (e.message||String(e)) || 'Failed to load';
    });
  }

  if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', main); }
  else { main(); }
})();
</script>
</body></html>
